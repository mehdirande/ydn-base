<h1 class="classTitle">Class ydn.db.Storage</h1>

<p>
Extends <a href="https://sites.google.com/a/yathit.com/ydn-dev/api-reference/ydn-db-core">ydn.db.Core</a>
</p>
<table cellspacing="0" class="summaryTable">



  <caption>
    Class Summary
  </caption>


  <thead>


  <tr>


    <th>Constructor Attributes</th>


    <th>Constructor Name and Description</th>
  </tr>
  </thead>


  <tbody>


  <tr>

    <td class="attributes">&nbsp;</td>




    <td class="nameDescription">



      <div class="fixedFont">
        <b><a href="#constructor">ydn.db.Storage</a></b>(name, schema, option)
      </div>


      <div class="description">
        Create a suitable storage mechanism.
      </div>
    </td>
  </tr>
  </tbody>
</table>


<table cellspacing="0" class="summaryTable">


<caption>
  Method Summary
</caption>



<thead>


<tr>


  <th>Method Attributes</th>



  <th>Method Name and Description</th>
</tr>
</thead>



<tbody>


<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>(store_name, id)
    </div>
    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>(store_name, ids)
    </div>
    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>(key)
    </div>
    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>(keys)
    </div>
    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>(store_name)
    </div>
    <div class="fixedFont">
      <b><a href="#clear">clear</a></b>()
    </div>


    <div class="description">
      Remove a specific entry or all entries from a store or all stores.
    </div>
  </td>
</tr>



<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#count">count</a></b>(store_name)
    </div>
    <div class="fixedFont">
      <b><a href="#count">count</a></b>()
    </div>




    <div class="description">
      Get number of items in a store or all stores.
    </div>
  </td>
</tr>



<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#get">get</a></b>(store_name, id)
    </div>
    <div class="fixedFont">
      <b><a href="#get">get</a></b>(store_name, ids)
    </div>
    <div class="fixedFont">
      <b><a href="#get">get</a></b>(store_name)
    </div>
    <div class="fixedFont">
      <b><a href="#get">get</a></b>(key)
    </div>
    <div class="fixedFont">
      <b><a href="#get">get</a></b>(keys)
    </div>
    <div class="fixedFont">
      <b><a href="#get">get</a></b>()
    </div>
    <div class="description">
      Retrieve an object or objects.
    </div>
  </td>
</tr>




<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#getItem">getItem</a></b>(id)
    </div>




    <div class="description">
      Retrieve a string value from default key-value store.
    </div>
  </td>
</tr>



<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#put">put</a></b>(store_name, value)
    </div>
    <div class="fixedFont">
      <b><a href="#put">put</a></b>(store_name, values)
    </div>



    <div class="description">
      Put an object or objects to a store.
    </div>
  </td>
</tr>



<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#getItem">query</a></b>()
    </div>


    <div class="description">
      Create a query.
    </div>
  </td>
</tr>


<tr>



  <td class="attributes">&nbsp;</td>




  <td class="nameDescription">



    <div class="fixedFont">
      <b><a href="#setItem">setItem</a></b>(key, value)
    </div>




    <div class="description">
      Store a value to default key-value store.
    </div>
  </td>
</tr>


<tr>
  <td class="attributes">&nbsp;</td>
  <td class="nameDescription">
    <div class="fixedFont">
      <b><a href="#encrypt">encrypt</a></b>(passphase, opt_expiration)
    </div>


    <div class="description">
      Encrypt the database using a passphase.
    </div>
  </td>
</tr>

<tr>
  <td class="attributes">&nbsp;</td>

  <td class="nameDescription">

    <div class="fixedFont">
      <b><a href="#run">run</a></b>(transaction_callback, store_names,
      mode, completed_event_handler)
    </div>

    <div class="description">
      Create isolated database transaction.
    </div>
  </td>
</tr>
</tbody>
</table>



<div class="details">
  <a name="constructor"></a>

  <div class="sectionTitle">
    Class Detail
  </div>

  <div class="fixedFont">
    <b>ydn.db.Storage</b>(opt_dbname, opt_schema, opt_options)
  </div>


  <dl class="detailList">
    <dt class="heading">See:</dt>

    <dd>Super class constructor: ydn.db.Core.</dd>
  </dl>
</div>




<div class="sectionTitle">
  Method Detail
</div>
<a name="clear"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>(store_name, id)
</div>

<div class="description">
  Remove a specific entry from a store.
</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>the store name.</dd>

  <dt><span class="light fixedFont">{string}</span> <b>id</b></dt>

  <dd>object key.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>(store_name, ids)
</div>

<div class="description">
  Remove list of objects from a store.
</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>store name.</dd>

  <dt><span class="light fixedFont">{string}</span> <b>ids</b></dt>

  <dd>List of object keys to clear.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>(key)
</div>

<div class="description">
  Remove a specific entry
</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{ydn.db.Key}</span> <b>key</b></dt>

  <dd>key to clear associated object.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>

<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>(keys)
</div>

<div class="description">
  Clear list of objects. Objects are not necessarily in a single store. Transaction is atomic.
</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{Array.<ydn.db.Key>}</span> <b>keys</b></dt>

  <dd>keys to clear associated objects.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>(store_name)
</div>

<div class="description">
  Clear all objects in the store.
</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{Array.<ydn.db.Key>}</span> <b>store_name</b></dt>

  <dd>store name.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>clear</b>()
</div>

<div class="description">
  Clear objects in the database.
</div>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return <code>true</code> in the deferred function.</dd>
</dl>


<hr>

<a name="count"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>count</b>(opt_store_name)
</div>


<div class="description">
  Get number of items in a store or all stores.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string=}</span> <b>opt_store_name</b></dt>

  <dd>store name, if not provided, count all entries in the database.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return number of items in deferred function.</dd>
</dl>

<hr>

<a name="get"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>(store_name, id)
</div>


<div class="description">
  Retrieve an object.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>The name of store to retrive object from.</dd>

  <dt><span class="light fixedFont">{string}</span> <b>id</b></dt>

  <dd>Key of an object to be retrieved. It is the value of the object in <code>keyPath</code> or auto-generated</dd>
</dl>

    <dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting object in deferred function. If not found, <code>undefined</code> is return.</dd>
</dl>




<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>(store_name, ids)
</div>


<div class="description">
  Retrieve objects.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>The name of store to retrive object from.</dd>

  <dt><span class="light fixedFont">{Array.<string>}</span> <b>ids</b></dt>

  <dd>Retrieve list of object from given ids.</dd>
</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting objects as array list in deferred function. If not found, <code>undefined</code> is return.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>(store_name)
</div>


<div class="description">
  Retrieve all objects in the store.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>The name of store to retrieve objects from.</dd>

</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting objects array list in deferred function.</dd>
</dl>



<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>()
</div>


<div class="description">
  Retrieve all objects in the database.
</div>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting objects array list in deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>(key)
</div>


<div class="description">
  Retrieve an object as referred by the given key.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{ydn.db.Key}</span> <b>key</b></dt>

  <dd>The key of the object to retrieve.</dd>

</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting object in deferred function.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>get</b>(keys)
</div>


<div class="description">
  Retrieve list of objects as referred by the given keys.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{!Array.<!ydn.db.Key>}</span> <b>keys</b></dt>

  <dd>The key of the object to retrieve.</dd>

</dl>

<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting objects as array list in deferred function.</dd>
</dl>

<hr>


<a name="getItem"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>getItem</b>(id)
</div>


<div class="description">
  Retrieve a value from default key-value store. If the value is stored in encrypted, this will decrypted with set passphase.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>id</b></dt>

  <dd>The key of the object to get. It is the value of object in <code>keyPath</code> or autogenerated.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return resulting object in deferred function. If not found, {@code undefined} is return.</dd>
</dl>

<hr>

<a name="put"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>put</b>(store_name, value)
</div>


<div class="description">
  Put an object to the store.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>the name of store to use.</dd>

  <dt><span class="light fixedFont">{!Object}</span> <b>value</b></dt>

  <dd>object to put.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return key in deferred function. On error, an {@code Error} object is return as received from the mechanism.</dd>
</dl>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>put</b>(store_name, values)
</div>


<div class="description">
  Put list of object to the store.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>store_name</b></dt>

  <dd>the name of store to use.</dd>

  <dt><span class="light fixedFont">{!Array}</span> <b>values</b></dt>

  <dd>list of objects to put.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> return list of keys in deferred function. On error, an {@code Error} object is return as received from the mechanism.</dd>
</dl>

<hr>


<a name="query"></a>


<div class="fixedFont">
  <span class="light">{!ydn.db.Query}</span> <b>query</b>()
</div>


<div class="description">
  Factory method for creating a query. See detail on Query class.
</div>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!ydn.db.Query}</span> return a <code>Query</code>.</dd>
</dl>

<hr>

<a name="setDbName"></a>


<div class="fixedFont">
  <span class="light">{string}</span> <b>setDbName</b>(opt_db_name)
</div>


<div class="description">
  Set database. This will initialize the database.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>opt_db_name</b></dt>

  <dd>set database name.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Throws:</dt>

  <dt><span class="light fixedFont">{Error}</span> </dt>

  <dd>if database is already initialized.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{string}</span> normalized database name.</dd>
</dl>

<hr>

<a name="setItem"></a>


<div class="fixedFont">
  <span class="light">{!goog.async.Deferred}</span> <b>setItem</b>(key, value)
</div>


<div class="description">
  Store a value to default key-value store. This will decrypt the value with the passphase provided.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>key</b></dt>

  <dd>The key to set.</dd>

  <dt><span class="light fixedFont">{string}</span> <b>value</b></dt>

  <dd>The value to save.</dd>
</dl>


<dl class="detailList">
  <dt class="heading">Returns:</dt>

  <dd><span class="light fixedFont">{!goog.async.Deferred}</span> true on success. undefined on fail.</dd>
</dl>

<hr>

<a name="setSchema"></a>


<div class="fixedFont">
  <b>setSchema</b>(schema)
</div>


<div class="description">
  Set the latest version of database schema. This will start initialization if database name have been set. The the database is already initialized, this will issue version change event and migrate to the schema.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{!ydn.db.DatabaseSchema|!Object}</span> <b>schema</b></dt>

  <dd>set the last schema or its configuration in JSON format.</dd>
</dl>

<hr>

<a name="encrypt"></a>


<div class="fixedFont">
  <b>encrypt</b>(passphase, opt_expiration)
</div>


<div class="description">
  Encrypt the database using a passphase. This is called before database is initialized, i.e, before <code>setName</code>
  to decrypt existing data. If this is called after the database initialized, passphase changing process occur.
  Value unable to encrypted will be discarded in the new database.
  <br />
  The passphase is generally generated from server side during the login process.
</div>


<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{string}</span> <b>passphase</b></dt>

  <dd>cryptographically strong phseudo random string.</dd>

  <dt><span class="light fixedFont">{number=}</span> <b>opt_expiration</b></dt>

  <dd>Expiration in milliseconds. If set, expired value are clear and return <code>undefined</code> upon retrieval.</dd>
</dl>


<hr>
<a name="run"></a>

<div class="fixedFont">
  <b>run</b>(transaction_callback, store_names,
  mode, completed_event_handler)
</div>

<div class="description">
  Preform a isolated non-overlapping database transaction asynchronously. If invoke from base
  <code>ydn.db.Storage</code> instance, this create a new transaction immediately. Subsequents call
  from the <code>ydn.db.tr.Storage</code> create non-overlapping transaction.</div>

<dl class="detailList">
  <dt class="heading">Parameters:</dt>

  <dt><span class="light fixedFont">{!function(ydn.db.tr.IStorage: tx)}</span> <b>transaction_callback</b></dt>

  <dd>Transaction in callback function. The callback is invoked <code>ydn.db.tr.IStorage</code> instance.
    Use <code>tx.getTx()</code> to get active transaction object, which could be either of  <code>IDBTransaction</code>,
    <code>SQLTransaction</code>, or <code>localStorage</code> depending on runtime environment.
    It returns <code>null</code> when transaction is no longer active.
    <br/>
    Use <code>tx.transaction(...)</code> to create another transaction from the queue. The callback will
    be invoked when previous one is completed.
  </dd>

  <dt><span class="light fixedFont">{Array.<string>}</span> <b>store_names</b></dt>

  <dd>List of store name. If empty list, all stores are open.</dd>

  <dt><span class="light fixedFont">{string}</span> <b>mode</b></dt>

  <dd>Transaction mode: <code>readonly</code> (default) or <code>readwrite</code>.</dd>

  <dt><span class="light fixedFont">{function(string: type, *: event)}</span> <b>completed_event_handler</b></dt>

  <dd>Handle event for transaction <code>completed</code>, <code>error</code> or <code>abort</code> event type.
    If provided, handler will be called once and only once immediately after the transacting become
    inactive. </dd>

  <dt><span class="light fixedFont">{...}</span> <b>opt_var_args</b></dt>

  <dd>Optional variable arguments pass back to <code>transaction_callback</code> post-pending to argument <code>tx</code></dd>


<pre>for (var i = 1; i &lt;= 3; i++) {
  console.log('Requesting to update player ' + i);
  db.run(function increaseHealth10(tx, i) {
    console.log('Updating player ' + i);
    var key = db.key('player', i);
    key.get().success(function(p1) {
      print_player(p1);
      p1.health += 10;
      key.put(p1).success(function(p1id) {
        console.log('Player ' + p1id + ' updated.');
      })
    })
  }, ['player'], 'readwrite', i)
}</pre>
